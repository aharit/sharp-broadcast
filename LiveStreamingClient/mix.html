<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<title>Live Streaming Example</title>
</head>

<body>
  
  <script type="text/javascript" src="audio/audio-worker-shim.min.js"></script>
  <script type="text/javascript" src="audio/audio-stream-player.js"></script>
  
  <script type="text/javascript" src="video/YUVCanvas.js"></script>
  <script type="text/javascript" src="video/Decoder.js"></script>
  <script type="text/javascript" src="video/Player.js"></script>
  <script type="text/javascript" src="video/video-stream-player.js"></script>
  
  <script type="text/javascript">
  
	var mediaServerIp = "127.0.0.1";
	
	var tryToUsePCM = true;
	var mixChannelName = "mix";
	
	AudioWorkerShim.polyfill();
	
	window.AudioContext = window.AudioContext       ||
						  window.webkitAudioContext ||
						  window.mozAudioContext    ||
						  window.oAudioContext      ||
						  window.msAudioContext;
	
	
	var audioCtx = new AudioContext();
	if (tryToUsePCM) {
		if (audioCtx.sampleRate == 44100 || audioCtx.sampleRate == 48000) {
			mixChannelName = "mix-" + audioCtx.sampleRate;
		}
	}
	
	// audio 
	
	var afilter = null;
	
	var aplayer = new SimpleWebAudioStreamPlayer({
						audioContext: audioCtx,
						useWorker: true,
						workerFile: "audio/audio-stream-process.js"
					});
	aplayer.enabled = false;
	
	if (tryToUsePCM) {
		
		afilter = audioCtx.createBiquadFilter();
		afilter.Q.value = 1.00;
		afilter.frequency.value = 1000;
		afilter.type = 'bandpass';
		
	}
	
	// video
	
	var vplayer = new SimpleWebVideoStreamPlayer({
		webgl: true,
		useWorker: true,
		workerFile : "video/Decoder.js",
		size: {width: 640, height: 360}
	});
	
	vplayer.onRenderFirstFrameComplete = function () {
		aplayer.enabled = true;
		document.getElementById('msg').innerHTML = 'playing ' + aplayer.mediaInfo + ' (if still no sound, please click here)';
	}
	
	// websocket
	
	var msocket = new WebSocket("ws://" + mediaServerIp + ":9320/" + mixChannelName);
	msocket.binaryType = "arraybuffer";
	msocket.onmessage = function(event) {
		var data = event.data;
		if (typeof data != "string") {
			var binarr = new Uint8Array(data);
			if (binarr[0] == 0 && binarr[1] == 0 && binarr[2] == 0 && binarr[3] == 1) {
				vplayer.decode(data);
			} else {
				aplayer.decode(data);
			}
		} else {
			console.log("media info: " + data);
			var mixinfoparts = data.split('|');
			var vinfopart = mixinfoparts[0];
			var ainfopart = mixinfoparts[1];
			if (vinfopart.indexOf("h264") < 0) {
				vinfopart = mixinfoparts[1];
				ainfopart = mixinfoparts[0];
			}
			console.log("video info: " + vinfopart);
			if (vplayer.domNode != null && vplayer.domNode.parentNode != null) {
				vplayer.updateMediaInfo(vinfopart);
			}
			console.log("audio info: " + ainfopart);
			aplayer.updateMediaInfo(ainfopart);
		}
	};
	msocket.onopen = function() {
		aplayer.open(afilter);
		document.getElementById('videoCanvas').appendChild(vplayer.domNode);
	};
	msocket.onclose = function() {
		aplayer.close();
		console.log('Audio player stopped');
	};
	
	
	function ios_unlock_sound() {
		if (!aplayer.isPlayingDummy) {
			aplayer.playDummy();
			if (!aplayer.enabled) aplayer.enabled = true;
			document.getElementById('msg').innerHTML = 'Done';
		}
	}
	
	window.addEventListener("touchend", ios_unlock_sound, false);
	window.addEventListener("mousedown", ios_unlock_sound, false);
	
	
  </script>
  
	<center>

	<div id="videoCanvas">
	</div>
	<font color="red">
	<span id="msg" style="position: relative; top: 10px;">Loading...</span>
	</font>
	</center>
	
</body>
</html>